<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>İsme Özel Doğum Günü Şarkıları</title>
  <link rel="stylesheet" href="style.css?v=4" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
</head>
<body>
  <header class="topbar">
    <h1>🎂 İsme Özel Doğum Günü Şarkıları</h1>
    <div class="search-wrap">
      <span class="search-icon">🔎</span>
      <input id="search" type="text" placeholder="İsmini yaz..." autocomplete="off" />
      <button id="clear" aria-label="Temizle">✖</button>
    </div>
  </header>

  <!-- Paylaş çubukları (üstte, videonun hemen üstünde olacak) -->
  <section id="shareBar" class="share hidden" aria-live="polite">
    <a id="waBtn" class="chip wa" target="_blank" rel="noopener">WhatsApp</a>
    <a id="fbBtn" class="chip fb" target="_blank" rel="noopener">Facebook</a>
    <a id="xBtn"  class="chip x"  target="_blank" rel="noopener">X</a>
    <a id="igBtn" class="chip ig" target="_blank" rel="noopener">Instagram</a>
    <button id="copyBtn" class="chip ghost">📋 Kopyala</button>
  </section>

  <!-- Sonuçlar -->
  <main class="container">
    <ul id="results" class="grid"></ul>

    <!-- Video -->
    <div id="player" class="video"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script>
    // ---- Veriyi yükle (names.json, yoksa isimler.json) ----
    let fuse, names = [];
    async function loadNames() {
      try {
        let res = await fetch('names.json', { cache: 'no-store' });
        if (!res.ok) res = await fetch('isimler.json', { cache: 'no-store' });
        names = await res.json();
        fuse = new Fuse(names, {
          keys: ['name'],
          threshold: 0.3,
          ignoreLocation: true,
          distance: 100
        });
      } catch (e) {
        console.error('İsim listesi yüklenemedi:', e);
      }
    }

    // ---- Grid’e kart bas ----
    function renderResults(items) {
      const grid = document.getElementById('results');
      grid.innerHTML = '';

      if (!items?.length) {
        grid.innerHTML = `<li class="empty">Sonuç bulunamadı</li>`;
        return;
      }

      items.forEach(({ item }) => {
        const li = document.createElement('li');
        li.className = 'card';
        li.innerHTML = `
          <button class="card-btn" title="${item.name}">
            <span class="avatar">🎵</span>
            <span class="label">${item.name}</span>
          </button>`;
        li.querySelector('.card-btn').onclick = () => play(item);
        grid.appendChild(li);
      });
    }

    // ---- Video oynat + paylaş linklerini hazırla ----
    function play(item) {
      const video = document.getElementById('player');
      const url = normalizeYoutube(item.youtube || item.youtube_url);
      if (!url) return;

      video.innerHTML = `
        <div class="ratio">
          <iframe
            src="${url}"
            title="${item.name}"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            referrerpolicy="strict-origin-when-cross-origin">
          </iframe>
        </div>`;

      updateShare(item.name, url);
      document.getElementById('shareBar').classList.remove('hidden');
      // aşağı kaydır (mobilde video görünsün)
      setTimeout(() => video.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
    }

    // Kısa YouTube linklerini embed’e çevir
    function normalizeYoutube(raw) {
      if (!raw) return null;
      const u = raw.trim()
        .replace(/\s+/g,'')
        .replace(/watch\?v=([A-Za-z0-9_-]+)/, 'embed/$1')
        .replace(/youtu\.be\/([A-Za-z0-9_-]+)/, 'www.youtube.com/embed/$1')
        .replace(/\/shorts\/([A-Za-z0-9_-?=]+)/, 'www.youtube.com/embed/$1');
      return u.startsWith('http') ? u : `https://${u}`;
    }

    // ---- Paylaş linkleri ----
    function updateShare(name, embedUrl) {
      // izleme linki: gömülü yerine normal video linki üretmeye çalış
      const watchUrl = embedUrl.replace('/embed/', '/watch?v=').replace('www.youtube.com/', 'https://www.youtube.com/');

      const text = `${name} için doğum günü şarkısı 🎂`;
      const page = location.href.split('#')[0]; // sayfan
      const shareLink = `${page}?name=${encodeURIComponent(name)}`;

      document.getElementById('waBtn').href =
        `https://wa.me/?text=${encodeURIComponent(text + ' ' + watchUrl)}`;

      document.getElementById('fbBtn').href =
        `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(watchUrl)}`;

      document.getElementById('xBtn').href =
        `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(watchUrl)}`;

      // Instagram web paylaşımı olmadığı için profil açalım (istersen değiştir)
      document.getElementById('igBtn').href = `https://www.instagram.com/`;

      document.getElementById('copyBtn').onclick = async () => {
        try {
          await navigator.clipboard.writeText(watchUrl);
          toast('Bağlantı kopyalandı ✅');
        } catch {
          toast('Kopyalanamadı ❌');
        }
      };
      // URL’ye isim ipucu
      history.replaceState({}, '', `#${encodeURIComponent(name)}`);
    }

    // ---- Arama ----
    let tId;
    function onSearchInput(e) {
      const q = e.target.value.trim();
      clearTimeout(tId);
      tId = setTimeout(() => {
        if (!q) {
          document.getElementById('results').innerHTML = '';
          return;
        }
        renderResults(fuse.search(q, { limit: 24 }));
      }, 120);
    }

    function onSearchEnter(e) {
      if (e.key === 'Enter') {
        const q = e.target.value.trim();
        if (!q) return;
        const r = fuse.search(q, { limit: 1 });
        if (r.length) play(r[0].item);
      }
    }

    function toast(msg) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.classList.add('show'), 10);
      setTimeout(() => { el.classList.remove('show'); el.remove(); }, 2200);
    }

    // ---- Init ----
    (async () => {
      await loadNames();
      const s = document.getElementById('search');
      s.addEventListener('input', onSearchInput);
      s.addEventListener('keydown', onSearchEnter);
      document.getElementById('clear').onclick = () => {
        s.value = '';
        document.getElementById('results').innerHTML = '';
      };
      // hash ile gelen isim varsa dene
      const hash = decodeURIComponent(location.hash.replace('#',''));
      if (hash) {
        const r = fuse.search(hash, { limit: 1 });
        if (r.length) play(r[0].item);
      }
    })();
  </script>
</body>
</html>
